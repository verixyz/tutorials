{"version":3,"file":"resolver.module.js","sources":["../src/resolver.ts"],"sourcesContent":["import fetch from 'cross-fetch'\nimport { DIDDocument, DIDResolutionResult, DIDResolver, ParsedDID } from 'did-resolver'\n\nconst DOC_PATH = '/.well-known/did.json'\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function get(url: string): Promise<any> {\n  const res = await fetch(url, { mode: 'cors' })\n  if (res.status >= 400) {\n    throw new Error(`Bad response ${res.statusText}`)\n  }\n  return res.json()\n}\n\nexport function getResolver(): Record<string, DIDResolver> {\n  async function resolve(did: string, parsed: ParsedDID): Promise<DIDResolutionResult> {\n    let err = null\n    let path = decodeURIComponent(parsed.id) + DOC_PATH\n    const id = parsed.id.split(':')\n    if (id.length > 1) {\n      path = id.map(decodeURIComponent).join('/') + '/did.json'\n    }\n\n    const url = `https://${path}`\n\n    const didDocumentMetadata = {}\n    let didDocument: DIDDocument | null = null\n\n    do {\n      try {\n        didDocument = await get(url)\n      } catch (error) {\n        err = `resolver_error: DID must resolve to a valid https URL containing a JSON document: ${error}`\n        break\n      }\n\n      // TODO: this excludes the use of query params\n      const docIdMatchesDid = didDocument?.id === did\n      if (!docIdMatchesDid) {\n        err = 'resolver_error: DID document id does not match requested did'\n        // break // uncomment this when adding more checks\n      }\n      // eslint-disable-next-line no-constant-condition\n    } while (false)\n\n    const contentType =\n      typeof didDocument?.['@context'] !== 'undefined' ? 'application/did+ld+json' : 'application/did+json'\n\n    if (err) {\n      return {\n        didDocument,\n        didDocumentMetadata,\n        didResolutionMetadata: {\n          error: 'notFound',\n          message: err,\n        },\n      }\n    } else {\n      return {\n        didDocument,\n        didDocumentMetadata,\n        didResolutionMetadata: { contentType },\n      }\n    }\n  }\n\n  return { web: resolve }\n}\n"],"names":["get","url","fetch","mode","res","status","Error","statusText","json","_settle","state","DOC_PATH","onRejected","e","result","getResolver","resolve","did","parsed","contentType","didDocument","err","didDocumentMetadata","didResolutionMetadata","error","message","path","decodeURIComponent","id","split","length","map","join","docIdMatchesDid","web"],"mappings":";;;;;;;;;;;;;;;;AAKA;MACeA,gBAAIC;;2BACCC,KAAK,CAACD,GAAD,EAAM;AAAEE,MAAAA,IAAI,EAAE;AAAR,KAAN,kBAAjBC;AACN,UAAIA,GAAG,CAACC,MAAJ,IAAc,GAAlB,EAAuB;AACrB,cAAM,IAAIC,KAAJ,iBAA0BF,GAAG,CAACG,YAA9B,CAAN;AACD;;AACD,aAAOH,GAAG,CAACI,IAAJ,EAAP;;AACD;;;;;;;;mBAwCO;;;;;;;;;;;;;iBAUDC,YAAA,KAAA,MAAA,OAAA;;;;aAIEC;;;;;;;;;;AA/DT,MAAMC,QAAQ,GAAG,uBAAjB;;;;;;;UAKMD;;;;;;;;;;;;;;;;;;;;;;;;;6BAuBcE;;;;eAKdC;gBACAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;SAvBUC;QACCC,oBAAQC,KAAaC;;;;;;;AA8BlC,cAAMC,WAAW,GACf,wBAAOC,WAAP,qBAAO,aAAc,UAAd,CAAP,MAAqC,WAArC,GAAmD,yBAAnD,GAA+E,sBADjF;;YAGIC;AACF,iBAAO;AACLD,YAAAA,WADK;AAELE,YAAAA,mBAFK;AAGLC,YAAAA,qBAAqB,EAAE;AACrBC,cAAAA,KAAK,EAAE,UADc;AAErBC,cAAAA,OAAO,EAAEJ;AAFY;AAHlB,WAAP;;AASA,iBAAO;AACLD,YAAAA,WADK;AAELE,YAAAA,mBAFK;AAGLC,YAAAA,qBAAqB,EAAE;AAAEJ,cAAAA;AAAF;AAHlB,WAAP;;;;AA1CF,UAAIE,GAAG,GAAG,IAAV;AACA,UAAIK,IAAI,GAAGC,kBAAkB,CAACT,MAAM,CAACU,EAAR,CAAlB,GAAgCjB,QAA3C;AACA,YAAMiB,EAAE,GAAGV,MAAM,CAACU,EAAP,CAAUC,KAAV,CAAgB,GAAhB,CAAX;;AACA,UAAID,EAAE,CAACE,MAAH,GAAY,CAAhB,EAAmB;AACjBJ,QAAAA,IAAI,GAAGE,EAAE,CAACG,GAAH,CAAOJ,kBAAP,EAA2BK,IAA3B,CAAgC,GAAhC,IAAuC,WAA9C;AACD;;AAED,YAAM/B,GAAG,cAAcyB,MAAvB;AAEA,YAAMJ,mBAAmB,GAAG,EAA5B;AACA,UAAIF,WAAW,GAAuB,IAAtC;;qCAEG;AAAA;AAAA;AAAA;;AAQD;AACA,kBAAMa,eAAe,GAAG,kBAAAb,WAAW,SAAX,0BAAaQ,EAAb,MAAoBX,GAA5C;;AATC,gBAUG,CAACgB,eAVJ;AAWCZ,cAAAA,GAAG,GAAG,8DAAN,CAXD;AAAA;AAAA;AAAA;;AAAA,yCACG;AAAA,iCACkBrB,GAAG,CAACC,GAAD,CADrB;AACFmB,YAAAA,WAAW,OAAX;AADE;AAEH,SAHA,YAGQI,KAHR,EAGe;AACdH,UAAAA,GAAG,wFAAwFG,OAA3F;AADc;AAGf,SANA;;AAAA;AAeF;8BAAQ;;;;AAqBV;;;;;AAED,SAAO;AAAEU,IAAAA,GAAG,EAAElB;AAAP,GAAP;AACD;;;;"}