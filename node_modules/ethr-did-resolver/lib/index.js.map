{"version":3,"file":"index.js","sources":["../src/helpers.ts","../src/configuration.ts","../src/controller.ts","../src/logParser.ts","../src/resolver.ts"],"sourcesContent":["import { getAddress } from '@ethersproject/address'\nimport { BigNumber } from '@ethersproject/bignumber'\nimport { computeAddress } from '@ethersproject/transactions'\nimport { VerificationMethod } from 'did-resolver'\n\nexport const identifierMatcher = /^(.*)?(0x[0-9a-fA-F]{40}|0x[0-9a-fA-F]{66})$/\nexport const nullAddress = '0x0000000000000000000000000000000000000000'\nexport const DEFAULT_REGISTRY_ADDRESS = '0xdca7ef03e98e0dc2b855be647c39abe984fcf21b'\nexport const DEFAULT_JSON_RPC = 'http://127.0.0.1:8545/'\n\nexport type address = string\nexport type uint256 = BigNumber\nexport type bytes32 = string\nexport type bytes = string\n\nexport interface ERC1056Event {\n  identity: address\n  previousChange: uint256\n  validTo?: uint256\n  _eventName: string\n  blockNumber: number\n}\n\nexport interface DIDOwnerChanged extends ERC1056Event {\n  owner: address\n}\n\nexport interface DIDAttributeChanged extends ERC1056Event {\n  name: bytes32\n  value: bytes\n  validTo: uint256\n}\n\nexport interface DIDDelegateChanged extends ERC1056Event {\n  delegateType: bytes32\n  delegate: address\n  validTo: uint256\n}\n\nexport enum verificationMethodTypes {\n  EcdsaSecp256k1VerificationKey2019 = 'EcdsaSecp256k1VerificationKey2019',\n  EcdsaSecp256k1RecoveryMethod2020 = 'EcdsaSecp256k1RecoveryMethod2020',\n  Ed25519VerificationKey2018 = 'Ed25519VerificationKey2018',\n  RSAVerificationKey2018 = 'RSAVerificationKey2018',\n  X25519KeyAgreementKey2019 = 'X25519KeyAgreementKey2019',\n}\n\nexport enum eventNames {\n  DIDOwnerChanged = 'DIDOwnerChanged',\n  DIDAttributeChanged = 'DIDAttributeChanged',\n  DIDDelegateChanged = 'DIDDelegateChanged',\n}\n\nexport interface LegacyVerificationMethod extends VerificationMethod {\n  /**@deprecated */\n  publicKeyHex?: string\n  /**@deprecated */\n  publicKeyBase64?: string\n  /**@deprecated */\n  publicKeyPem?: string\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [x: string]: any\n}\n\nexport const legacyAttrTypes: Record<string, string> = {\n  sigAuth: 'SignatureAuthentication2018',\n  veriKey: 'VerificationKey2018',\n  enc: 'KeyAgreementKey2019',\n}\n\nexport const legacyAlgoMap: Record<string, string> = {\n  /**@deprecated */\n  Secp256k1VerificationKey2018: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n  /**@deprecated */\n  Ed25519SignatureAuthentication2018: verificationMethodTypes.Ed25519VerificationKey2018,\n  /**@deprecated */\n  Secp256k1SignatureAuthentication2018: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n  //keep legacy mapping\n  RSAVerificationKey2018: verificationMethodTypes.RSAVerificationKey2018,\n  Ed25519VerificationKey2018: verificationMethodTypes.Ed25519VerificationKey2018,\n  X25519KeyAgreementKey2019: verificationMethodTypes.X25519KeyAgreementKey2019,\n}\n\nexport function strip0x(input: string): string {\n  return input.startsWith('0x') ? input.slice(2) : input\n}\n\nexport function bytes32toString(input: bytes32 | Uint8Array): string {\n  const buff: Buffer = typeof input === 'string' ? Buffer.from(input.slice(2), 'hex') : Buffer.from(input)\n  return buff.toString('utf8').replace(/\\0+$/, '')\n}\n\nexport function stringToBytes32(str: string): string {\n  const buffStr = '0x' + Buffer.from(str).slice(0, 32).toString('hex')\n  return buffStr + '0'.repeat(66 - buffStr.length)\n}\n\nexport function interpretIdentifier(identifier: string): { address: string; publicKey?: string; network?: string } {\n  let id = identifier\n  let network = undefined\n  if (id.startsWith('did:ethr')) {\n    id = id.split('?')[0]\n    const components = id.split(':')\n    id = components[components.length - 1]\n    if (components.length >= 4) {\n      network = components.splice(2, components.length - 3).join(':')\n    }\n  }\n  if (id.length > 42) {\n    return { address: computeAddress(id), publicKey: id, network }\n  } else {\n    return { address: getAddress(id), network } // checksum address\n  }\n}\n\nexport const knownInfuraNetworks: Record<string, string> = {\n  mainnet: '0x1',\n  ropsten: '0x3',\n  rinkeby: '0x4',\n  goerli: '0x5',\n  kovan: '0x2a',\n}\n\nexport const knownNetworks: Record<string, string> = {\n  ...knownInfuraNetworks,\n  rsk: '0x1e',\n  'rsk:testnet': '0x1f',\n  artis_t1: '0x03c401',\n  artis_s1: '0x03c301',\n  matic: '0x89',\n  maticmum: '0x13881',\n}\n\nexport enum Errors {\n  /**\n   * The resolver has failed to construct the DID document.\n   * This can be caused by a network issue, a wrong registry address or malformed logs while parsing the registry history.\n   * Please inspect the `DIDResolutionMetadata.message` to debug further.\n   */\n  notFound = 'notFound',\n\n  /**\n   * The resolver does not know how to resolve the given DID. Most likely it is not a `did:ethr`.\n   */\n  invalidDid = 'invalidDid',\n\n  /**\n   * The resolver is misconfigured or is being asked to resolve a DID anchored on an unknown network\n   */\n  unknownNetwork = 'unknownNetwork',\n}\n","import { BigNumber } from '@ethersproject/bignumber'\nimport { Contract, ContractFactory } from '@ethersproject/contracts'\nimport { InfuraProvider, JsonRpcProvider, Provider } from '@ethersproject/providers'\nimport DidRegistryContract from 'ethr-did-registry'\nimport { DEFAULT_REGISTRY_ADDRESS, knownInfuraNetworks, knownNetworks } from './helpers'\n\n/**\n * A configuration entry for an ethereum network\n * It should contain at least one of `name` or `chainId` AND one of `provider`, `web3`, or `rpcUrl`\n *\n * @example ```js\n * { name: 'development', registry: '0x9af37603e98e0dc2b855be647c39abe984fc2445', rpcUrl: 'http://127.0.0.1:8545/' }\n * { name: 'goerli', chainId: 5, provider: new InfuraProvider('goerli') }\n * { name: 'rinkeby', provider: new AlchemyProvider('rinkeby') }\n * { name: 'rsk:testnet', chainId: '0x1f', rpcUrl: 'https://public-node.testnet.rsk.co' }\n * ```\n */\nexport interface ProviderConfiguration {\n  name?: string\n  provider?: Provider\n  rpcUrl?: string\n  registry?: string\n  chainId?: string | number\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  web3?: any\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [index: string]: any\n}\n\nexport interface MultiProviderConfiguration extends ProviderConfiguration {\n  networks?: ProviderConfiguration[]\n}\n\nexport interface InfuraConfiguration {\n  infuraProjectId: string\n}\n\nexport type ConfigurationOptions = MultiProviderConfiguration | InfuraConfiguration\n\nexport type ConfiguredNetworks = Record<string, Contract>\n\nfunction configureNetworksWithInfura(projectId?: string): ConfiguredNetworks {\n  if (!projectId) {\n    return {}\n  }\n  const networks: ProviderConfiguration[] = [\n    { name: 'mainnet', chainId: '0x1', provider: new InfuraProvider('homestead', projectId) },\n    { name: 'ropsten', chainId: '0x3', provider: new InfuraProvider('ropsten', projectId) },\n    { name: 'rinkeby', chainId: '0x4', provider: new InfuraProvider('rinkeby', projectId) },\n    { name: 'goerli', chainId: '0x5', provider: new InfuraProvider('goerli', projectId) },\n    { name: 'kovan', chainId: '0x2a', provider: new InfuraProvider('kovan', projectId) },\n  ]\n  return configureNetworks({ networks })\n}\n\nexport function getContractForNetwork(conf: ProviderConfiguration): Contract {\n  let provider: Provider = conf.provider || conf.web3?.currentProvider\n  if (!provider) {\n    if (conf.rpcUrl) {\n      const chainIdRaw = conf.chainId ? conf.chainId : knownNetworks[conf.name || '']\n      const chainId = chainIdRaw ? BigNumber.from(chainIdRaw).toNumber() : chainIdRaw\n      const networkName = knownInfuraNetworks[conf.name || ''] ? conf.name?.replace('mainnet', 'homestead') : 'any'\n      provider = new JsonRpcProvider(conf.rpcUrl, chainId || networkName)\n    } else {\n      throw new Error(`invalid_config: No web3 provider could be determined for network ${conf.name || conf.chainId}`)\n    }\n  }\n  const contract: Contract = ContractFactory.fromSolidity(DidRegistryContract)\n    .attach(conf.registry || DEFAULT_REGISTRY_ADDRESS)\n    .connect(provider)\n  return contract\n}\n\nfunction configureNetwork(net: ProviderConfiguration): ConfiguredNetworks {\n  const networks: ConfiguredNetworks = {}\n  const chainId = net.chainId || knownNetworks[net.name || '']\n  if (chainId) {\n    if (net.name) {\n      networks[net.name] = getContractForNetwork(net)\n    }\n    const id = typeof chainId === 'number' ? `0x${chainId.toString(16)}` : chainId\n    networks[id] = getContractForNetwork(net)\n  } else if (net.provider || net.web3 || net.rpcUrl) {\n    networks[net.name || ''] = getContractForNetwork(net)\n  }\n  return networks\n}\n\nfunction configureNetworks(conf: MultiProviderConfiguration): ConfiguredNetworks {\n  return {\n    ...configureNetwork(conf),\n    ...conf.networks?.reduce<ConfiguredNetworks>((networks, net) => {\n      return { ...networks, ...configureNetwork(net) }\n    }, {}),\n  }\n}\n\n/**\n * Generates a configuration that maps ethereum network names and chainIDs to the respective ERC1056 contracts deployed on them.\n * @returns a record of ERC1056 `Contract` instances\n * @param conf configuration options for the resolver. An array of network details.\n * Each network entry should contain at least one of `name` or `chainId` AND one of `provider`, `web3`, or `rpcUrl`\n * For convenience, you can also specify an `infuraProjectId` which will create a mapping for all the networks supported by https://infura.io.\n * @example ```js\n * [\n *   { name: 'development', registry: '0x9af37603e98e0dc2b855be647c39abe984fc2445', rpcUrl: 'http://127.0.0.1:8545/' },\n *   { name: 'goerli', chainId: 5, provider: new InfuraProvider('goerli') },\n *   { name: 'rinkeby', provider: new AlchemyProvider('rinkeby') },\n *   { name: 'rsk:testnet', chainId: '0x1f', rpcUrl: 'https://public-node.testnet.rsk.co' },\n * ]\n * ```\n */\nexport function configureResolverWithNetworks(conf: ConfigurationOptions = {}): ConfiguredNetworks {\n  const networks = {\n    ...configureNetworksWithInfura((<InfuraConfiguration>conf).infuraProjectId),\n    ...configureNetworks(<MultiProviderConfiguration>conf),\n  }\n  if (Object.keys(networks).length === 0) {\n    throw new Error('invalid_config: Please make sure to have at least one network')\n  }\n  return networks\n}\n","import { Signer } from '@ethersproject/abstract-signer'\nimport { CallOverrides, Contract } from '@ethersproject/contracts'\nimport { BlockTag, JsonRpcProvider, Provider, TransactionReceipt } from '@ethersproject/providers'\nimport { getContractForNetwork } from './configuration'\nimport { address, DEFAULT_REGISTRY_ADDRESS, interpretIdentifier, stringToBytes32 } from './helpers'\n\n/**\n * A class that can be used to interact with the ERC1056 contract on behalf of a local controller key-pair\n */\nexport class EthrDidController {\n  private contract: Contract\n  private signer?: Signer\n  private address: string\n  public did: string\n\n  /**\n   * Creates an EthrDidController instance.\n   *\n   * @param identifier - required - a `did:ethr` string or a publicKeyHex or an ethereum address\n   * @param signer - optional - a Signer that represents the current controller key (owner) of the identifier. If a 'signer' is not provided, then a 'contract' with an attached signer can be used.\n   * @param contract - optional - a Contract instance representing a ERC1056 contract. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param chainNameOrId - optional - the network name or chainID, defaults to 'mainnet'\n   * @param provider - optional - a web3 Provider. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param rpcUrl - optional - a JSON-RPC URL that can be used to connect to an ethereum network. At least one of `contract`, `provider`, or `rpcUrl` is required\n   * @param registry - optional - The ERC1056 registry address. Defaults to '0xdca7ef03e98e0dc2b855be647c39abe984fcf21b'. Only used with 'provider' or 'rpcUrl'\n   */\n  constructor(\n    identifier: string | address,\n    contract?: Contract,\n    signer?: Signer,\n    chainNameOrId = 'mainnet',\n    provider?: Provider,\n    rpcUrl?: string,\n    registry: string = DEFAULT_REGISTRY_ADDRESS\n  ) {\n    // initialize identifier\n    const { address, publicKey, network } = interpretIdentifier(identifier)\n    const net = network || chainNameOrId\n    // initialize contract connection\n    if (contract) {\n      this.contract = contract\n    } else if (provider || signer?.provider || rpcUrl) {\n      const prov = provider || signer?.provider\n      this.contract = getContractForNetwork({ name: net, provider: prov, registry, rpcUrl })\n    } else {\n      throw new Error(' either a contract instance or a provider or rpcUrl is required to initialize')\n    }\n    this.signer = signer\n    this.address = address\n    let networkString = net ? `${net}:` : ''\n    if (networkString in ['mainnet:', '0x1:']) {\n      networkString = ''\n    }\n    this.did = publicKey ? `did:ethr:${networkString}${publicKey}` : `did:ethr:${networkString}${address}`\n  }\n\n  async getOwner(address: address, blockTag?: BlockTag): Promise<string> {\n    const result = await this.contract.functions.identityOwner(address, { blockTag })\n    return result[0]\n  }\n\n  async attachContract(controller?: address | Promise<address>): Promise<Contract> {\n    const currentOwner = controller ? await controller : await this.getOwner(this.address, 'latest')\n    const signer = this.signer\n      ? this.signer\n      : (<JsonRpcProvider>this.contract.provider).getSigner(currentOwner) || this.contract.signer\n    return this.contract.connect(signer)\n  }\n\n  async changeOwner(newOwner: address, options: CallOverrides = {}): Promise<TransactionReceipt> {\n    // console.log(`changing owner for ${oldOwner} on registry at ${registryContract.address}`)\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n\n    const ownerChange = await contract.functions.changeOwner(this.address, newOwner, overrides)\n    return await ownerChange.wait()\n  }\n\n  async addDelegate(\n    delegateType: string,\n    delegateAddress: address,\n    exp: number,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n\n    const delegateTypeBytes = stringToBytes32(delegateType)\n    const addDelegateTx = await contract.functions.addDelegate(\n      this.address,\n      delegateTypeBytes,\n      delegateAddress,\n      exp,\n      overrides\n    )\n    addDelegateTx\n    return await addDelegateTx.wait()\n  }\n\n  async revokeDelegate(\n    delegateType: string,\n    delegateAddress: address,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    delegateType = delegateType.startsWith('0x') ? delegateType : stringToBytes32(delegateType)\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const addDelegateTx = await contract.functions.revokeDelegate(\n      this.address,\n      delegateType,\n      delegateAddress,\n      overrides\n    )\n    return await addDelegateTx.wait()\n  }\n\n  async setAttribute(\n    attrName: string,\n    attrValue: string,\n    exp: number,\n    options: CallOverrides = {}\n  ): Promise<TransactionReceipt> {\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      controller: undefined,\n      ...options,\n    }\n    attrName = attrName.startsWith('0x') ? attrName : stringToBytes32(attrName)\n    attrValue = attrValue.startsWith('0x') ? attrValue : '0x' + Buffer.from(attrValue, 'utf-8').toString('hex')\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const setAttrTx = await contract.functions.setAttribute(this.address, attrName, attrValue, exp, overrides)\n    return await setAttrTx.wait()\n  }\n\n  async revokeAttribute(attrName: string, attrValue: string, options: CallOverrides = {}): Promise<TransactionReceipt> {\n    // console.log(`revoking attribute ${attrName}(${attrValue}) for ${identity}`)\n    const overrides = {\n      gasLimit: 123456,\n      gasPrice: 1000000000,\n      ...options,\n    }\n    attrName = attrName.startsWith('0x') ? attrName : stringToBytes32(attrName)\n    attrValue = attrValue.startsWith('0x') ? attrValue : '0x' + Buffer.from(attrValue, 'utf-8').toString('hex')\n    const contract = await this.attachContract(overrides.from)\n    delete overrides.from\n    const revokeAttributeTX = await contract.functions.revokeAttribute(this.address, attrName, attrValue, overrides)\n    return await revokeAttributeTX.wait()\n  }\n}\n","import { BigNumber } from '@ethersproject/bignumber'\nimport { Contract } from '@ethersproject/contracts'\nimport { Log } from '@ethersproject/providers'\nimport { LogDescription } from '@ethersproject/abi'\nimport { bytes32toString, ERC1056Event } from './helpers'\n\nfunction populateEventMetaClass(logResult: LogDescription, blockNumber: number): ERC1056Event {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const result: Record<string, any> = {}\n  if (logResult.eventFragment.inputs.length !== logResult.args.length) {\n    throw new TypeError('malformed event input. wrong number of arguments')\n  }\n  logResult.eventFragment.inputs.forEach((input, index) => {\n    let val = logResult.args[index]\n    if (typeof val === 'object') {\n      val = BigNumber.from(val)\n    }\n    if (input.type === 'bytes32') {\n      val = bytes32toString(val)\n    }\n    result[input.name] = val\n  })\n  result._eventName = logResult.name\n  result.blockNumber = blockNumber\n  return result as ERC1056Event\n}\n\nexport function logDecoder(contract: Contract, logs: Log[]): ERC1056Event[] {\n  const results: ERC1056Event[] = logs.map((log: Log) => {\n    const res = contract.interface.parseLog(log)\n    const event = populateEventMetaClass(res, log.blockNumber)\n    return event\n  })\n  return results\n}\n","import { Base58 } from '@ethersproject/basex'\nimport { BigNumber } from '@ethersproject/bignumber'\nimport { Block, BlockTag } from '@ethersproject/providers'\nimport { ConfigurationOptions, ConfiguredNetworks, configureResolverWithNetworks } from './configuration'\nimport { EthrDidController } from './controller'\nimport {\n  DIDDocument,\n  DIDResolutionOptions,\n  DIDResolutionResult,\n  DIDResolver,\n  ParsedDID,\n  Resolvable,\n  ServiceEndpoint,\n  VerificationMethod,\n} from 'did-resolver'\nimport {\n  interpretIdentifier,\n  DIDAttributeChanged,\n  DIDDelegateChanged,\n  ERC1056Event,\n  eventNames,\n  legacyAlgoMap,\n  legacyAttrTypes,\n  LegacyVerificationMethod,\n  verificationMethodTypes,\n  identifierMatcher,\n  nullAddress,\n  DIDOwnerChanged,\n  knownNetworks,\n  Errors,\n  strip0x,\n} from './helpers'\nimport { logDecoder } from './logParser'\n\nexport function getResolver(options: ConfigurationOptions): Record<string, DIDResolver> {\n  return new EthrDidResolver(options).build()\n}\n\nexport class EthrDidResolver {\n  private contracts: ConfiguredNetworks\n\n  constructor(options: ConfigurationOptions) {\n    this.contracts = configureResolverWithNetworks(options)\n  }\n\n  /**\n   * returns the current owner of a DID (represented by an address or public key)\n   *\n   * @param address\n   */\n  async getOwner(address: string, networkId: string, blockTag?: BlockTag): Promise<string> {\n    //TODO: check if address or public key\n    return new EthrDidController(address, this.contracts[networkId]).getOwner(address, blockTag)\n  }\n\n  /**\n   * returns the previous change\n   *\n   * @param address\n   */\n  async previousChange(address: string, networkId: string, blockTag?: BlockTag): Promise<BigNumber> {\n    const result = await this.contracts[networkId].functions.changed(address, { blockTag })\n    // console.log(`last change result: '${BigNumber.from(result['0'])}'`)\n    return BigNumber.from(result['0'])\n  }\n\n  async getBlockMetadata(blockHeight: number, networkId: string): Promise<{ height: string; isoDate: string }> {\n    const block: Block = await this.contracts[networkId].provider.getBlock(blockHeight)\n    return {\n      height: block.number.toString(),\n      isoDate: new Date(block.timestamp * 1000).toISOString().replace('.000', ''),\n    }\n  }\n\n  async changeLog(\n    identity: string,\n    networkId: string,\n    blockTag: BlockTag = 'latest'\n  ): Promise<{ address: string; history: ERC1056Event[]; controllerKey?: string; chainId: number }> {\n    const contract = this.contracts[networkId]\n    const provider = contract.provider\n    const hexChainId = networkId.startsWith('0x') ? networkId : knownNetworks[networkId]\n    //TODO: this can be used to check if the configuration is ok\n    const chainId = hexChainId ? BigNumber.from(hexChainId).toNumber() : (await provider.getNetwork()).chainId\n    const history: ERC1056Event[] = []\n    const { address, publicKey } = interpretIdentifier(identity)\n    const controllerKey = publicKey\n    let previousChange: BigNumber | null = await this.previousChange(address, networkId, blockTag)\n    while (previousChange) {\n      const blockNumber = previousChange\n      // console.log(`gigel ${previousChange}`)\n      const fromBlock =\n        previousChange.toHexString() !== '0x00' ? previousChange.sub(1).toHexString() : previousChange.toHexString()\n      const logs = await provider.getLogs({\n        address: contract.address, // networks[networkId].registryAddress,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        topics: [null as any, `0x000000000000000000000000${address.slice(2)}`],\n        fromBlock,\n        toBlock: previousChange.toHexString(),\n      })\n      const events: ERC1056Event[] = logDecoder(contract, logs)\n      events.reverse()\n      previousChange = null\n      for (const event of events) {\n        history.unshift(event)\n        if (event.previousChange.lt(blockNumber)) {\n          previousChange = event.previousChange\n        }\n      }\n    }\n    return { address, history, controllerKey, chainId }\n  }\n\n  wrapDidDocument(\n    did: string,\n    address: string,\n    controllerKey: string | undefined,\n    history: ERC1056Event[],\n    chainId: number,\n    blockHeight: string | number,\n    now: BigNumber\n  ): { didDocument: DIDDocument; deactivated: boolean; versionId: number; nextVersionId: number } {\n    const baseDIDDocument: DIDDocument = {\n      '@context': [\n        'https://www.w3.org/ns/did/v1',\n        'https://identity.foundation/EcdsaSecp256k1RecoverySignature2020/lds-ecdsa-secp256k1-recovery2020-0.0.jsonld',\n      ],\n      id: did,\n      verificationMethod: [],\n      authentication: [],\n      assertionMethod: [],\n    }\n\n    let controller = address\n\n    const authentication = [`${did}#controller`]\n    const keyAgreement: string[] = []\n\n    let versionId = 0\n    let nextVersionId = Number.POSITIVE_INFINITY\n    let deactivated = false\n    let delegateCount = 0\n    let serviceCount = 0\n    const auth: Record<string, string> = {}\n    const keyAgreementRefs: Record<string, string> = {}\n    const pks: Record<string, VerificationMethod> = {}\n    const services: Record<string, ServiceEndpoint> = {}\n    for (const event of history) {\n      if (blockHeight !== -1 && event.blockNumber > blockHeight) {\n        if (nextVersionId > event.blockNumber) {\n          nextVersionId = event.blockNumber\n        }\n        continue\n      } else {\n        if (versionId < event.blockNumber) {\n          versionId = event.blockNumber\n        }\n      }\n      const validTo = event.validTo || BigNumber.from(0)\n      const eventIndex = `${event._eventName}-${\n        (<DIDDelegateChanged>event).delegateType || (<DIDAttributeChanged>event).name\n      }-${(<DIDDelegateChanged>event).delegate || (<DIDAttributeChanged>event).value}`\n      if (validTo && validTo.gte(now)) {\n        if (event._eventName === eventNames.DIDDelegateChanged) {\n          const currentEvent = <DIDDelegateChanged>event\n          delegateCount++\n          const delegateType = currentEvent.delegateType //conversion from bytes32 is done in logParser\n          switch (delegateType) {\n            case 'sigAuth':\n              auth[eventIndex] = `${did}#delegate-${delegateCount}`\n            // eslint-disable-line no-fallthrough\n            case 'veriKey':\n              pks[eventIndex] = {\n                id: `${did}#delegate-${delegateCount}`,\n                type: verificationMethodTypes.EcdsaSecp256k1RecoveryMethod2020,\n                controller: did,\n                blockchainAccountId: `${currentEvent.delegate}@eip155:${chainId}`,\n              }\n              break\n          }\n        } else if (event._eventName === eventNames.DIDAttributeChanged) {\n          const currentEvent = <DIDAttributeChanged>event\n          const name = currentEvent.name //conversion from bytes32 is done in logParser\n          const match = name.match(/^did\\/(pub|svc)\\/(\\w+)(\\/(\\w+))?(\\/(\\w+))?$/)\n          if (match) {\n            const section = match[1]\n            const algorithm = match[2]\n            const type = legacyAttrTypes[match[4]] || match[4]\n            const encoding = match[6]\n            switch (section) {\n              case 'pub': {\n                delegateCount++\n                const pk: LegacyVerificationMethod = {\n                  id: `${did}#delegate-${delegateCount}`,\n                  type: `${algorithm}${type}`,\n                  controller: did,\n                }\n                pk.type = legacyAlgoMap[pk.type] || algorithm\n                switch (encoding) {\n                  case null:\n                  case undefined:\n                  case 'hex':\n                    pk.publicKeyHex = strip0x(currentEvent.value)\n                    break\n                  case 'base64':\n                    pk.publicKeyBase64 = Buffer.from(currentEvent.value.slice(2), 'hex').toString('base64')\n                    break\n                  case 'base58':\n                    pk.publicKeyBase58 = Base58.encode(Buffer.from(currentEvent.value.slice(2), 'hex'))\n                    break\n                  case 'pem':\n                    pk.publicKeyPem = Buffer.from(currentEvent.value.slice(2), 'hex').toString()\n                    break\n                  default:\n                    pk.value = strip0x(currentEvent.value)\n                }\n                pks[eventIndex] = pk\n                if (match[4] === 'sigAuth') {\n                  auth[eventIndex] = pk.id\n                } else if (match[4] === 'enc') {\n                  keyAgreementRefs[eventIndex] = pk.id\n                }\n                break\n              }\n              case 'svc':\n                serviceCount++\n                services[eventIndex] = {\n                  id: `${did}#service-${serviceCount}`,\n                  type: algorithm,\n                  serviceEndpoint: Buffer.from(currentEvent.value.slice(2), 'hex').toString(),\n                }\n                break\n            }\n          }\n        }\n      } else if (event._eventName === eventNames.DIDOwnerChanged) {\n        const currentEvent = <DIDOwnerChanged>event\n        controller = currentEvent.owner\n        if (currentEvent.owner === nullAddress) {\n          deactivated = true\n          break\n        }\n      } else {\n        if (\n          event._eventName === eventNames.DIDDelegateChanged ||\n          (event._eventName === eventNames.DIDAttributeChanged &&\n            (<DIDAttributeChanged>event).name.match(/^did\\/pub\\//))\n        ) {\n          delegateCount++\n        } else if (\n          event._eventName === eventNames.DIDAttributeChanged &&\n          (<DIDAttributeChanged>event).name.match(/^did\\/svc\\//)\n        ) {\n          serviceCount++\n        }\n        delete auth[eventIndex]\n        delete pks[eventIndex]\n        delete services[eventIndex]\n      }\n    }\n\n    const publicKeys: VerificationMethod[] = [\n      {\n        id: `${did}#controller`,\n        type: verificationMethodTypes.EcdsaSecp256k1RecoveryMethod2020,\n        controller: did,\n        blockchainAccountId: `${controller}@eip155:${chainId}`,\n      },\n    ]\n\n    if (controllerKey && controller == address) {\n      publicKeys.push({\n        id: `${did}#controllerKey`,\n        type: verificationMethodTypes.EcdsaSecp256k1VerificationKey2019,\n        controller: did,\n        publicKeyHex: strip0x(controllerKey),\n      })\n      authentication.push(`${did}#controllerKey`)\n    }\n\n    const didDocument: DIDDocument = {\n      ...baseDIDDocument,\n      verificationMethod: publicKeys.concat(Object.values(pks)),\n      authentication: authentication.concat(Object.values(auth)),\n    }\n    if (Object.values(services).length > 0) {\n      didDocument.service = Object.values(services)\n    }\n    if (Object.values(keyAgreementRefs).length > 0) {\n      didDocument.keyAgreement = keyAgreement.concat(Object.values(keyAgreementRefs))\n    }\n    didDocument.assertionMethod = [...(didDocument.verificationMethod?.map((pk) => pk.id) || [])]\n\n    return deactivated\n      ? {\n          didDocument: { ...baseDIDDocument, '@context': 'https://www.w3.org/ns/did/v1' },\n          deactivated,\n          versionId,\n          nextVersionId,\n        }\n      : { didDocument, deactivated, versionId, nextVersionId }\n  }\n\n  async resolve(\n    did: string,\n    parsed: ParsedDID,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _unused: Resolvable,\n    options: DIDResolutionOptions\n  ): Promise<DIDResolutionResult> {\n    const fullId = parsed.id.match(identifierMatcher)\n    if (!fullId) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.invalidDid,\n          message: `Not a valid did:ethr: ${parsed.id}`,\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n    const id = fullId[2]\n    const networkId = !fullId[1] ? 'mainnet' : fullId[1].slice(0, -1)\n    let blockTag: string | number = options.blockTag || 'latest'\n    if (typeof parsed.query === 'string') {\n      const qParams = new URLSearchParams(parsed.query)\n      blockTag = qParams.get('versionId') ?? blockTag\n      try {\n        blockTag = Number.parseInt(<string>blockTag)\n      } catch (e) {\n        blockTag = 'latest'\n        // invalid versionId parameters are ignored\n      }\n    }\n\n    if (!this.contracts[networkId]) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.unknownNetwork,\n          message: `The DID resolver does not have a configuration for network: ${networkId}`,\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n\n    let now = BigNumber.from(Math.floor(new Date().getTime() / 1000))\n\n    if (typeof blockTag === 'number') {\n      const block = await this.getBlockMetadata(blockTag, networkId)\n      now = BigNumber.from(Date.parse(block.isoDate) / 1000)\n    } else {\n      // 'latest'\n    }\n\n    const { address, history, controllerKey, chainId } = await this.changeLog(id, networkId, 'latest')\n    try {\n      const { didDocument, deactivated, versionId, nextVersionId } = this.wrapDidDocument(\n        did,\n        address,\n        controllerKey,\n        history,\n        chainId,\n        blockTag,\n        now\n      )\n      const status = deactivated ? { deactivated: true } : {}\n      let versionMeta = {}\n      let versionMetaNext = {}\n      if (versionId !== 0) {\n        const block = await this.getBlockMetadata(versionId, networkId)\n        versionMeta = {\n          versionId: block.height,\n          updated: block.isoDate,\n        }\n      }\n      if (nextVersionId !== Number.POSITIVE_INFINITY) {\n        const block = await this.getBlockMetadata(nextVersionId, networkId)\n        versionMetaNext = {\n          nextVersionId: block.height,\n          nextUpdate: block.isoDate,\n        }\n      }\n      return {\n        didDocumentMetadata: { ...status, ...versionMeta, ...versionMetaNext },\n        didResolutionMetadata: { contentType: 'application/did+ld+json' },\n        didDocument,\n      }\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    } catch (e: any) {\n      return {\n        didResolutionMetadata: {\n          error: Errors.notFound,\n          message: e.toString(), // This is not in spec, nut may be helpful\n        },\n        didDocumentMetadata: {},\n        didDocument: null,\n      }\n    }\n  }\n\n  build(): Record<string, DIDResolver> {\n    return { ethr: this.resolve.bind(this) }\n  }\n}\n"],"names":["identifierMatcher","nullAddress","DEFAULT_REGISTRY_ADDRESS","verificationMethodTypes","eventNames","legacyAttrTypes","sigAuth","veriKey","enc","legacyAlgoMap","Secp256k1VerificationKey2018","EcdsaSecp256k1VerificationKey2019","Ed25519SignatureAuthentication2018","Ed25519VerificationKey2018","Secp256k1SignatureAuthentication2018","RSAVerificationKey2018","X25519KeyAgreementKey2019","strip0x","input","startsWith","slice","bytes32toString","buff","Buffer","from","toString","replace","stringToBytes32","str","buffStr","repeat","length","interpretIdentifier","identifier","id","network","undefined","split","components","splice","join","address","computeAddress","publicKey","getAddress","knownInfuraNetworks","mainnet","ropsten","rinkeby","goerli","kovan","knownNetworks","rsk","artis_t1","artis_s1","matic","maticmum","Errors","configureNetworksWithInfura","projectId","networks","name","chainId","provider","InfuraProvider","configureNetworks","getContractForNetwork","conf","web3","currentProvider","rpcUrl","chainIdRaw","BigNumber","toNumber","networkName","JsonRpcProvider","Error","contract","ContractFactory","fromSolidity","DidRegistryContract","attach","registry","connect","configureNetwork","net","reduce","configureResolverWithNetworks","infuraProjectId","Object","keys","EthrDidController","constructor","signer","chainNameOrId","did","prov","networkString","getOwner","blockTag","functions","identityOwner","result","attachContract","controller","currentOwner","getSigner","changeOwner","newOwner","options","overrides","gasLimit","gasPrice","ownerChange","wait","addDelegate","delegateType","delegateAddress","exp","delegateTypeBytes","addDelegateTx","revokeDelegate","setAttribute","attrName","attrValue","setAttrTx","revokeAttribute","revokeAttributeTX","populateEventMetaClass","logResult","blockNumber","eventFragment","inputs","args","TypeError","forEach","index","val","type","_eventName","logDecoder","logs","results","map","log","res","interface","parseLog","event","state","prototype","s","thenable","update","shouldContinue","body","_resumeAfterBody","_resumeAfterTest","getResolver","EthrDidResolver","build","contracts","networkId","previousChange","changed","getBlockMetadata","blockHeight","getBlock","block","height","number","isoDate","Date","timestamp","toISOString","changeLog","identity","hexChainId","history","controllerKey","fromBlock","toHexString","sub","getLogs","topics","toBlock","events","reverse","unshift","lt","getNetwork","wrapDidDocument","now","baseDIDDocument","verificationMethod","authentication","assertionMethod","keyAgreement","versionId","nextVersionId","Number","POSITIVE_INFINITY","deactivated","delegateCount","serviceCount","auth","keyAgreementRefs","pks","services","validTo","eventIndex","delegate","value","gte","DIDDelegateChanged","currentEvent","EcdsaSecp256k1RecoveryMethod2020","blockchainAccountId","DIDAttributeChanged","match","section","algorithm","encoding","pk","publicKeyHex","publicKeyBase64","publicKeyBase58","Base58","encode","publicKeyPem","serviceEndpoint","DIDOwnerChanged","owner","publicKeys","push","didDocument","concat","values","service","resolve","parsed","_unused","didDocumentMetadata","status","versionMeta","versionMetaNext","didResolutionMetadata","contentType","nextUpdate","updated","e","error","notFound","message","fullId","invalidDid","query","qParams","URLSearchParams","get","parseInt","unknownNetwork","Math","floor","getTime","parse","ethr","bind"],"mappings":"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"}