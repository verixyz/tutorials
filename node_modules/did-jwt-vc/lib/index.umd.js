!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("did-jwt")):"function"==typeof define&&define.amd?define(["exports","did-jwt"],t):t((e||self).didJwtVc={},e.didJwt)}(this,function(e,t){const n="ES256K",r=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/,i="https://www.w3.org/2018/credentials/v1",o="VerifiableCredential",a="VerifiablePresentation",l="JwtProof2020",c=["evidence","termsOfUse","refreshService","credentialSchema","credentialStatus"];function s(e){return Array.isArray(e)?e:[e]}function d(e){return Array.isArray(e)?e.map(e=>d(e)):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce((t,n)=>(Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n)),t[n]=d(e[n]),t),Object.create(Object.getPrototypeOf(e))):e}function f(e){return null!=e}function u(e,t=!0){var n,r,a,l;let u=d(e);var p,v,y;"object"==typeof(p=e)&&p.sub&&p.iss&&p.claim&&p.iat&&(u=function(e){const{iat:t,nbf:n,claim:r,vc:a,...l}=e,c={...l,nbf:n||t,vc:{"@context":[i],type:[o],credentialSubject:r}};return a&&(e.issVc=a),c}(e)),u.credentialSubject={...e.credentialSubject,...null==(n=e.vc)?void 0:n.credentialSubject},!e.sub||null!=(r=e.credentialSubject)&&r.id||!u.credentialSubject||(u.credentialSubject.id=e.sub,t&&delete u.sub),t&&(null==(v=u.vc)||delete v.credentialSubject),void 0!==e.issuer&&"object"!=typeof e.issuer||(u.issuer=function(e){if("object"!=typeof e)return e;const t={...e};return Object.keys(t).forEach(e=>void 0===t[e]&&delete t[e]),t}({id:e.iss,...e.issuer}),!t||null!=(y=e.issuer)&&y.id||delete u.iss),!e.id&&e.jti&&(u.id=u.id||u.jti,t&&delete u.jti);const b=[...s(u.type),...s(null==(a=u.vc)?void 0:a.type)].filter(f);var w;u.type=[...new Set(b)],t&&(null==(w=u.vc)||delete w.type);for(const n of c)e.vc&&e.vc[n]&&(u[n]||(u[n]=e.vc[n]),t&&delete u.vc[n]);const x=[...s(e.context),...s(e["@context"]),...s(null==(l=e.vc)?void 0:l["@context"])].filter(f);var j;return u["@context"]=[...new Set(x)],t&&(delete u.context,null==(j=u.vc)||delete j["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(u.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete u.nbf:delete u.iat)),!e.expirationDate&&e.exp&&(u.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete u.exp),t&&u.vc&&0===Object.keys(u.vc).length&&delete u.vc,u}function p(e,n=!0){let r;try{r=t.decodeJWT(e)}catch(e){throw new TypeError("unknown credential format")}return{...u(r.payload,n),proof:{type:l,jwt:e}}}function v(e,t=!0){var n;if("string"==typeof e){if(r.test(e))return p(e,t);{let n;try{n=JSON.parse(e)}catch(e){throw new TypeError("unknown credential format")}return v(n,t)}}return null!=(n=e.proof)&&n.jwt?d({...p(e.proof.jwt,t),proof:e.proof}):{proof:{},...u(e,t)}}function y(e,t=!0){var n,r,i;if(Array.isArray(e.credentialSubject))throw Error("credentialSubject of type array not supported");const o=d({vc:{...e.vc},...e});o.vc=o.vc;const a={...e.credentialSubject,...null==(n=e.vc)?void 0:n.credentialSubject};var l;e.sub||(o.sub=null==(l=e.credentialSubject)?void 0:l.id,t&&delete a.id);const u=[...s(e.context),...s(e["@context"]),...s(null==(r=e.vc)?void 0:r["@context"])].filter(f);o.vc["@context"]=[...new Set(u)],t&&(delete o.context,delete o["@context"]);const p=[...s(e.type),...s(null==(i=e.vc)?void 0:i.type)].filter(f);if(o.vc.type=[...new Set(p)],t&&delete o.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(o.jti=e.id,t&&delete o.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const n=Date.parse(e.issuanceDate);isNaN(n)||(o.nbf=Math.floor(n/1e3),t&&delete o.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const n=Date.parse(e.expirationDate);isNaN(n)||(o.exp=Math.floor(n/1e3),t&&delete o.expirationDate)}var v;e.issuer&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&("object"==typeof e.issuer?(o.iss=null==(v=e.issuer)?void 0:v.id,t&&(delete o.issuer.id,0===Object.keys(o.issuer).length&&delete o.issuer)):"string"==typeof e.issuer&&(o.iss=e.iss||""+e.issuer,t&&delete o.issuer)),o.vc.credentialSubject=a,t&&delete o.credentialSubject;for(const n of c)e[n]&&(o.vc[n]||(o.vc[n]=e[n]),t&&delete o[n]);return o}function b(e,t=!0){var n,r,i;const o=d(e);var a;o.verifiableCredential=[...s(e.verifiableCredential),...s(null==(n=e.vp)?void 0:n.verifiableCredential)].filter(f),o.verifiableCredential=o.verifiableCredential.map(e=>v(e,t)),t&&(null==(a=o.vp)||delete a.verifiableCredential),e.iss&&!e.holder&&(o.holder=e.iss,t&&delete o.iss),e.aud&&(o.verifier=[...s(e.verifier),...s(e.aud)].filter(f),o.verifier=[...new Set(o.verifier)],t&&delete o.aud),e.jti&&-1===Object.getOwnPropertyNames(e).indexOf("id")&&(o.id=e.id||e.jti,t&&delete o.jti);const l=[...s(e.type),...s(null==(r=e.vp)?void 0:r.type)].filter(f);var c;o.type=[...new Set(l)],t&&(null==(c=o.vp)||delete c.type);const u=[...s(e.context),...s(e["@context"]),...s(null==(i=e.vp)?void 0:i["@context"])].filter(f);var p;return o["@context"]=[...new Set(u)],t&&(delete o.context,null==(p=o.vp)||delete p["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(o.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete o.nbf:delete o.iat)),!e.expirationDate&&e.exp&&(o.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete o.exp),o.vp&&0===Object.keys(o.vp).length&&t&&delete o.vp,o}function w(e,n=!0){let r;try{r=t.decodeJWT(e)}catch(e){throw new TypeError("unknown presentation format")}return{...b(r.payload,n),proof:{type:l,jwt:e}}}function x(e,t=!0){var n;if("string"==typeof e){if(r.test(e))return w(e,t);{let n;try{n=JSON.parse(e)}catch(e){throw new TypeError("unknown presentation format")}return x(n,t)}}return null!=(n=e.proof)&&n.jwt?{...w(e.proof.jwt,t),proof:e.proof}:{proof:{},...b(e,t)}}function j(e,t=!0){var n,r,i;const o=d({vp:{...e.vp},...e});o.vp=o.vp;const a=[...s(e.context),...s(e["@context"]),...s(null==(n=e.vp)?void 0:n["@context"])].filter(f);o.vp["@context"]=[...new Set(a)],t&&(delete o.context,delete o["@context"]);const l=[...s(e.type),...s(null==(r=e.vp)?void 0:r.type)].filter(f);if(o.vp.type=[...new Set(l)],t&&delete o.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(o.jti=e.id,t&&delete o.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const n=Date.parse(e.issuanceDate);isNaN(n)||(o.nbf=Math.floor(n/1e3),t&&delete o.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const n=Date.parse(e.expirationDate);isNaN(n)||(o.exp=Math.floor(n/1e3),t&&delete o.expirationDate)}var c;if((o.verifiableCredential||null!=(i=o.vp)&&i.verifiableCredential)&&(o.vp.verifiableCredential=[...s(o.verifiableCredential),...s(null==(c=o.vp)?void 0:c.verifiableCredential)].filter(f).map(e=>{var t;return"object"==typeof e&&null!=(t=e.proof)&&t.jwt?e.proof.jwt:e})),t&&delete o.verifiableCredential,e.holder&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&"string"==typeof e.holder&&(o.iss=e.holder,t&&delete o.holder),e.verifier){const n=[...s(e.verifier),...s(e.aud)].filter(f);o.aud=[...new Set(n)],t&&delete o.verifier}return o}function h(e){if("string"==typeof e&&!e.match(r))throw new TypeError(`"${e}" is not a valid JWT format`)}function g(e){if("number"==typeof e){if(!(Number.isInteger(e)&&e<1e11))throw new TypeError(`"${e}" is not a unix timestamp in seconds`)}else if("string"==typeof e)g(Math.floor(new Date(e).valueOf()/1e3));else if(!(t=e)||isNaN(t)||"[object Date]"!==Object.prototype.toString.call(t))throw new TypeError(`"${e}" is not a valid time`);var t}function m(e){const t=s(e);if(t.length<1||-1===t.indexOf(i))throw new TypeError(`@context is missing default context "${i}"`)}function O(e){const t=s(e);if(t.length<1||-1===t.indexOf(o))throw new TypeError(`type is missing default "${o}"`)}function S(e){const t=s(e);if(t.length<1||-1===t.indexOf(a))throw new TypeError(`type is missing default "${a}"`)}function P(e){if(0===Object.keys(e).length)throw new TypeError("credentialSubject must not be empty")}function D(e){m(e.vc["@context"]),O(e.vc.type),P(e.vc.credentialSubject),e.nbf&&g(e.nbf),e.exp&&g(e.exp)}function C(e){m(e["@context"]),O(e.type),P(e.credentialSubject),e.issuanceDate&&g(e.issuanceDate),e.expirationDate&&g(e.expirationDate)}function N(e){if(m(e.vp["@context"]),S(e.vp.type),e.vp.verifiableCredential&&e.vp.verifiableCredential.length>=1)for(const t of s(e.vp.verifiableCredential))"string"==typeof t?h(t):C(t);e.exp&&g(e.exp)}function T(e){if(m(e["@context"]),S(e.type),e.verifiableCredential&&e.verifiableCredential.length>=1)for(const t of e.verifiableCredential)"string"==typeof t?h(t):C(t);e.expirationDate&&g(e.expirationDate)}function J(e,t){if(t.challenge&&t.challenge!==e.nonce)throw new Error(`Presentation does not contain the mandatory challenge (JWT: nonce) for : ${t.challenge}`);if(t.domain){let n;if(e.aud&&(n=(Array.isArray(e.aud)?e.aud:[e.aud]).find(e=>t.domain===e)),void 0===n)throw new Error(`Presentation does not contain the mandatory domain (JWT: aud) for : ${t.domain}`)}}e.createVerifiableCredentialJwt=function(e,r,i={}){try{var o;const a={iat:void 0,...y(e,i.removeOriginalFields)};return D(a),Promise.resolve(t.createJWT(a,{...i,issuer:r.did||a.iss||"",signer:r.signer},{...i.header,alg:r.alg||(null==(o=i.header)?void 0:o.alg)||n}))}catch(e){return Promise.reject(e)}},e.createVerifiablePresentationJwt=function(e,r,i={}){try{var o;const a={iat:void 0,...j(e,null==i?void 0:i.removeOriginalFields)};if(i.challenge&&-1===Object.getOwnPropertyNames(a).indexOf("nonce")&&(a.nonce=i.challenge),i.domain){const e=[...s(i.domain),...s(a.aud)].filter(f);a.aud=[...new Set(e)]}return N(a),Promise.resolve(t.createJWT(a,{...i,issuer:r.did||a.iss||"",signer:r.signer},{...i.header,alg:r.alg||(null==(o=i.header)?void 0:o.alg)||n}))}catch(e){return Promise.reject(e)}},e.normalizeCredential=v,e.normalizePresentation=x,e.transformCredentialInput=y,e.transformPresentationInput=j,e.validateCredentialPayload=C,e.validateJwtCredentialPayload=D,e.validateJwtPresentationPayload=N,e.validatePresentationPayload=T,e.verifyCredential=function(e,n,r={}){try{return Promise.resolve(t.verifyJWT(e,{resolver:n,...r})).then(function(e){return e.verifiableCredential=v(e.jwt,null==r?void 0:r.removeOriginalFields),C(e.verifiableCredential),e})}catch(e){return Promise.reject(e)}},e.verifyPresentation=function(e,n,r={}){try{return Promise.resolve(t.verifyJWT(e,{resolver:n,...r})).then(function(e){return J(e.payload,r),e.verifiablePresentation=x(e.jwt,null==r?void 0:r.removeOriginalFields),T(e.verifiablePresentation),e})}catch(e){return Promise.reject(e)}},e.verifyPresentationPayloadOptions=J});
//# sourceMappingURL=index.umd.js.map
