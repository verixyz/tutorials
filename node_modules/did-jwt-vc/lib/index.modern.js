import{decodeJWT as e,createJWT as t,verifyJWT as n}from"did-jwt";function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}const r=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/,o="https://www.w3.org/2018/credentials/v1",a=["iat","nbf","claim","vc"],l=["evidence","termsOfUse","refreshService","credentialSchema","credentialStatus"];function c(e){return Array.isArray(e)?e:[e]}function s(e){return Array.isArray(e)?e.map(e=>s(e)):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce((t,n)=>(Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n)),t[n]=s(e[n]),t),Object.create(Object.getPrototypeOf(e))):e}function d(e){return null!=e}function f(e,t=!0){var n,r,f,u;let p=s(e);var v,b,y;"object"==typeof(v=e)&&v.sub&&v.iss&&v.claim&&v.iat&&(p=function(e){const{iat:t,nbf:n,claim:r,vc:l}=e,c=i({},function(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)t.indexOf(n=o[i])>=0||(r[n]=e[n]);return r}(e,a),{nbf:n||t,vc:{"@context":[o],type:["VerifiableCredential"],credentialSubject:r}});return l&&(e.issVc=l),c}(e)),p.credentialSubject=i({},e.credentialSubject,null==(n=e.vc)?void 0:n.credentialSubject),!e.sub||null!=(r=e.credentialSubject)&&r.id||!p.credentialSubject||(p.credentialSubject.id=e.sub,t&&delete p.sub),t&&(null==(b=p.vc)||delete b.credentialSubject),void 0!==e.issuer&&"object"!=typeof e.issuer||(p.issuer=function(e){if("object"!=typeof e)return e;const t=i({},e);return Object.keys(t).forEach(e=>void 0===t[e]&&delete t[e]),t}(i({id:e.iss},e.issuer)),!t||null!=(y=e.issuer)&&y.id||delete p.iss),!e.id&&e.jti&&(p.id=p.id||p.jti,t&&delete p.jti);const w=[...c(p.type),...c(null==(f=p.vc)?void 0:f.type)].filter(d);var x;p.type=[...new Set(w)],t&&(null==(x=p.vc)||delete x.type);for(const n of l)e.vc&&e.vc[n]&&(p[n]||(p[n]=e.vc[n]),t&&delete p.vc[n]);const j=[...c(e.context),...c(e["@context"]),...c(null==(u=e.vc)?void 0:u["@context"])].filter(d);var g;return p["@context"]=[...new Set(j)],t&&(delete p.context,null==(g=p.vc)||delete g["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(p.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete p.nbf:delete p.iat)),!e.expirationDate&&e.exp&&(p.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete p.exp),t&&p.vc&&0===Object.keys(p.vc).length&&delete p.vc,p}function u(t,n=!0){let r;try{r=e(t)}catch(e){throw new TypeError("unknown credential format")}return i({},f(r.payload,n),{proof:{type:"JwtProof2020",jwt:t}})}function p(e,t=!0){var n;if("string"==typeof e){if(r.test(e))return u(e,t);{let n;try{n=JSON.parse(e)}catch(e){throw new TypeError("unknown credential format")}return p(n,t)}}return null!=(n=e.proof)&&n.jwt?s(i({},u(e.proof.jwt,t),{proof:e.proof})):i({proof:{}},f(e,t))}function v(e,t=!0){var n,r,o;if(Array.isArray(e.credentialSubject))throw Error("credentialSubject of type array not supported");const a=s(i({vc:i({},e.vc)},e));a.vc=a.vc;const f=i({},e.credentialSubject,null==(n=e.vc)?void 0:n.credentialSubject);var u;e.sub||(a.sub=null==(u=e.credentialSubject)?void 0:u.id,t&&delete f.id);const p=[...c(e.context),...c(e["@context"]),...c(null==(r=e.vc)?void 0:r["@context"])].filter(d);a.vc["@context"]=[...new Set(p)],t&&(delete a.context,delete a["@context"]);const v=[...c(e.type),...c(null==(o=e.vc)?void 0:o.type)].filter(d);if(a.vc.type=[...new Set(v)],t&&delete a.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(a.jti=e.id,t&&delete a.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const n=Date.parse(e.issuanceDate);isNaN(n)||(a.nbf=Math.floor(n/1e3),t&&delete a.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const n=Date.parse(e.expirationDate);isNaN(n)||(a.exp=Math.floor(n/1e3),t&&delete a.expirationDate)}var b;e.issuer&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&("object"==typeof e.issuer?(a.iss=null==(b=e.issuer)?void 0:b.id,t&&(delete a.issuer.id,0===Object.keys(a.issuer).length&&delete a.issuer)):"string"==typeof e.issuer&&(a.iss=e.iss||""+e.issuer,t&&delete a.issuer)),a.vc.credentialSubject=f,t&&delete a.credentialSubject;for(const n of l)e[n]&&(a.vc[n]||(a.vc[n]=e[n]),t&&delete a[n]);return a}function b(e,t=!0){var n,i,r;const o=s(e);var a;o.verifiableCredential=[...c(e.verifiableCredential),...c(null==(n=e.vp)?void 0:n.verifiableCredential)].filter(d),o.verifiableCredential=o.verifiableCredential.map(e=>p(e,t)),t&&(null==(a=o.vp)||delete a.verifiableCredential),e.iss&&!e.holder&&(o.holder=e.iss,t&&delete o.iss),e.aud&&(o.verifier=[...c(e.verifier),...c(e.aud)].filter(d),o.verifier=[...new Set(o.verifier)],t&&delete o.aud),e.jti&&-1===Object.getOwnPropertyNames(e).indexOf("id")&&(o.id=e.id||e.jti,t&&delete o.jti);const l=[...c(e.type),...c(null==(i=e.vp)?void 0:i.type)].filter(d);var f;o.type=[...new Set(l)],t&&(null==(f=o.vp)||delete f.type);const u=[...c(e.context),...c(e["@context"]),...c(null==(r=e.vp)?void 0:r["@context"])].filter(d);var v;return o["@context"]=[...new Set(u)],t&&(delete o.context,null==(v=o.vp)||delete v["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(o.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete o.nbf:delete o.iat)),!e.expirationDate&&e.exp&&(o.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete o.exp),o.vp&&0===Object.keys(o.vp).length&&t&&delete o.vp,o}function y(t,n=!0){let r;try{r=e(t)}catch(e){throw new TypeError("unknown presentation format")}return i({},b(r.payload,n),{proof:{type:"JwtProof2020",jwt:t}})}function w(e,t=!0){var n;if("string"==typeof e){if(r.test(e))return y(e,t);{let n;try{n=JSON.parse(e)}catch(e){throw new TypeError("unknown presentation format")}return w(n,t)}}return null!=(n=e.proof)&&n.jwt?i({},y(e.proof.jwt,t),{proof:e.proof}):i({proof:{}},b(e,t))}function x(e,t=!0){var n,r,o;const a=s(i({vp:i({},e.vp)},e));a.vp=a.vp;const l=[...c(e.context),...c(e["@context"]),...c(null==(n=e.vp)?void 0:n["@context"])].filter(d);a.vp["@context"]=[...new Set(l)],t&&(delete a.context,delete a["@context"]);const f=[...c(e.type),...c(null==(r=e.vp)?void 0:r.type)].filter(d);if(a.vp.type=[...new Set(f)],t&&delete a.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(a.jti=e.id,t&&delete a.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const n=Date.parse(e.issuanceDate);isNaN(n)||(a.nbf=Math.floor(n/1e3),t&&delete a.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const n=Date.parse(e.expirationDate);isNaN(n)||(a.exp=Math.floor(n/1e3),t&&delete a.expirationDate)}var u;if((a.verifiableCredential||null!=(o=a.vp)&&o.verifiableCredential)&&(a.vp.verifiableCredential=[...c(a.verifiableCredential),...c(null==(u=a.vp)?void 0:u.verifiableCredential)].filter(d).map(e=>{var t;return"object"==typeof e&&null!=(t=e.proof)&&t.jwt?e.proof.jwt:e})),t&&delete a.verifiableCredential,e.holder&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&"string"==typeof e.holder&&(a.iss=e.holder,t&&delete a.holder),e.verifier){const n=[...c(e.verifier),...c(e.aud)].filter(d);a.aud=[...new Set(n)],t&&delete a.verifier}return a}function j(e){if("string"==typeof e&&!e.match(r))throw new TypeError(`"${e}" is not a valid JWT format`)}function g(e){if("number"==typeof e){if(!(Number.isInteger(e)&&e<1e11))throw new TypeError(`"${e}" is not a unix timestamp in seconds`)}else if("string"==typeof e)g(Math.floor(new Date(e).valueOf()/1e3));else if(!(t=e)||isNaN(t)||"[object Date]"!==Object.prototype.toString.call(t))throw new TypeError(`"${e}" is not a valid time`);var t}function O(e){const t=c(e);if(t.length<1||-1===t.indexOf(o))throw new TypeError(`@context is missing default context "${o}"`)}function h(e){const t=c(e);if(t.length<1||-1===t.indexOf("VerifiableCredential"))throw new TypeError('type is missing default "VerifiableCredential"')}function m(e){const t=c(e);if(t.length<1||-1===t.indexOf("VerifiablePresentation"))throw new TypeError('type is missing default "VerifiablePresentation"')}function S(e){if(0===Object.keys(e).length)throw new TypeError("credentialSubject must not be empty")}async function D(e,n,r={}){var o;const a=i({iat:void 0},v(e,r.removeOriginalFields));return C(a),t(a,i({},r,{issuer:n.did||a.iss||"",signer:n.signer}),i({},r.header,{alg:n.alg||(null==(o=r.header)?void 0:o.alg)||"ES256K"}))}async function N(e,n,r={}){var o;const a=i({iat:void 0},x(e,null==r?void 0:r.removeOriginalFields));if(r.challenge&&-1===Object.getOwnPropertyNames(a).indexOf("nonce")&&(a.nonce=r.challenge),r.domain){const e=[...c(r.domain),...c(a.aud)].filter(d);a.aud=[...new Set(e)]}return E(a),t(a,i({},r,{issuer:n.did||a.iss||"",signer:n.signer}),i({},r.header,{alg:n.alg||(null==(o=r.header)?void 0:o.alg)||"ES256K"}))}function C(e){O(e.vc["@context"]),h(e.vc.type),S(e.vc.credentialSubject),e.nbf&&g(e.nbf),e.exp&&g(e.exp)}function P(e){O(e["@context"]),h(e.type),S(e.credentialSubject),e.issuanceDate&&g(e.issuanceDate),e.expirationDate&&g(e.expirationDate)}function E(e){if(O(e.vp["@context"]),m(e.vp.type),e.vp.verifiableCredential&&e.vp.verifiableCredential.length>=1)for(const t of c(e.vp.verifiableCredential))"string"==typeof t?j(t):P(t);e.exp&&g(e.exp)}function T(e){if(O(e["@context"]),m(e.type),e.verifiableCredential&&e.verifiableCredential.length>=1)for(const t of e.verifiableCredential)"string"==typeof t?j(t):P(t);e.expirationDate&&g(e.expirationDate)}async function A(e,t,r={}){const o=await n(e,i({resolver:t},r));return o.verifiableCredential=p(o.jwt,null==r?void 0:r.removeOriginalFields),P(o.verifiableCredential),o}function k(e,t){if(t.challenge&&t.challenge!==e.nonce)throw new Error(`Presentation does not contain the mandatory challenge (JWT: nonce) for : ${t.challenge}`);if(t.domain){let n;if(e.aud&&(n=(Array.isArray(e.aud)?e.aud:[e.aud]).find(e=>t.domain===e)),void 0===n)throw new Error(`Presentation does not contain the mandatory domain (JWT: aud) for : ${t.domain}`)}}async function J(e,t,r={}){const o=await n(e,i({resolver:t},r));return k(o.payload,r),o.verifiablePresentation=w(o.jwt,null==r?void 0:r.removeOriginalFields),T(o.verifiablePresentation),o}export{D as createVerifiableCredentialJwt,N as createVerifiablePresentationJwt,p as normalizeCredential,w as normalizePresentation,v as transformCredentialInput,x as transformPresentationInput,P as validateCredentialPayload,C as validateJwtCredentialPayload,E as validateJwtPresentationPayload,T as validatePresentationPayload,A as verifyCredential,J as verifyPresentation,k as verifyPresentationPayloadOptions};
//# sourceMappingURL=index.modern.js.map
