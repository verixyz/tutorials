var e=require("did-jwt");const t=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/,r="https://www.w3.org/2018/credentials/v1",n=["evidence","termsOfUse","refreshService","credentialSchema","credentialStatus"];function i(e){return Array.isArray(e)?e:[e]}function o(e){return Array.isArray(e)?e.map(e=>o(e)):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce((t,r)=>(Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r)),t[r]=o(e[r]),t),Object.create(Object.getPrototypeOf(e))):e}function a(e){return null!=e}function l(e,t=!0){var l,c,s,d;let f=o(e);var u,p,v;"object"==typeof(u=e)&&u.sub&&u.iss&&u.claim&&u.iat&&(f=function(e){const{iat:t,nbf:n,claim:i,vc:o,...a}=e,l={...a,nbf:n||t,vc:{"@context":[r],type:["VerifiableCredential"],credentialSubject:i}};return o&&(e.issVc=o),l}(e)),f.credentialSubject={...e.credentialSubject,...null==(l=e.vc)?void 0:l.credentialSubject},!e.sub||null!=(c=e.credentialSubject)&&c.id||!f.credentialSubject||(f.credentialSubject.id=e.sub,t&&delete f.sub),t&&(null==(p=f.vc)||delete p.credentialSubject),void 0!==e.issuer&&"object"!=typeof e.issuer||(f.issuer=function(e){if("object"!=typeof e)return e;const t={...e};return Object.keys(t).forEach(e=>void 0===t[e]&&delete t[e]),t}({id:e.iss,...e.issuer}),!t||null!=(v=e.issuer)&&v.id||delete f.iss),!e.id&&e.jti&&(f.id=f.id||f.jti,t&&delete f.jti);const y=[...i(f.type),...i(null==(s=f.vc)?void 0:s.type)].filter(a);var b;f.type=[...new Set(y)],t&&(null==(b=f.vc)||delete b.type);for(const r of n)e.vc&&e.vc[r]&&(f[r]||(f[r]=e.vc[r]),t&&delete f.vc[r]);const x=[...i(e.context),...i(e["@context"]),...i(null==(d=e.vc)?void 0:d["@context"])].filter(a);var w;return f["@context"]=[...new Set(x)],t&&(delete f.context,null==(w=f.vc)||delete w["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(f.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete f.nbf:delete f.iat)),!e.expirationDate&&e.exp&&(f.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete f.exp),t&&f.vc&&0===Object.keys(f.vc).length&&delete f.vc,f}function c(t,r=!0){let n;try{n=e.decodeJWT(t)}catch(e){throw new TypeError("unknown credential format")}return{...l(n.payload,r),proof:{type:"JwtProof2020",jwt:t}}}function s(e,r=!0){var n;if("string"==typeof e){if(t.test(e))return c(e,r);{let t;try{t=JSON.parse(e)}catch(e){throw new TypeError("unknown credential format")}return s(t,r)}}return null!=(n=e.proof)&&n.jwt?o({...c(e.proof.jwt,r),proof:e.proof}):{proof:{},...l(e,r)}}function d(e,t=!0){var r,l,c;if(Array.isArray(e.credentialSubject))throw Error("credentialSubject of type array not supported");const s=o({vc:{...e.vc},...e});s.vc=s.vc;const d={...e.credentialSubject,...null==(r=e.vc)?void 0:r.credentialSubject};var f;e.sub||(s.sub=null==(f=e.credentialSubject)?void 0:f.id,t&&delete d.id);const u=[...i(e.context),...i(e["@context"]),...i(null==(l=e.vc)?void 0:l["@context"])].filter(a);s.vc["@context"]=[...new Set(u)],t&&(delete s.context,delete s["@context"]);const p=[...i(e.type),...i(null==(c=e.vc)?void 0:c.type)].filter(a);if(s.vc.type=[...new Set(p)],t&&delete s.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(s.jti=e.id,t&&delete s.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const r=Date.parse(e.issuanceDate);isNaN(r)||(s.nbf=Math.floor(r/1e3),t&&delete s.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const r=Date.parse(e.expirationDate);isNaN(r)||(s.exp=Math.floor(r/1e3),t&&delete s.expirationDate)}var v;e.issuer&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&("object"==typeof e.issuer?(s.iss=null==(v=e.issuer)?void 0:v.id,t&&(delete s.issuer.id,0===Object.keys(s.issuer).length&&delete s.issuer)):"string"==typeof e.issuer&&(s.iss=e.iss||""+e.issuer,t&&delete s.issuer)),s.vc.credentialSubject=d,t&&delete s.credentialSubject;for(const r of n)e[r]&&(s.vc[r]||(s.vc[r]=e[r]),t&&delete s[r]);return s}function f(e,t=!0){var r,n,l;const c=o(e);var d;c.verifiableCredential=[...i(e.verifiableCredential),...i(null==(r=e.vp)?void 0:r.verifiableCredential)].filter(a),c.verifiableCredential=c.verifiableCredential.map(e=>s(e,t)),t&&(null==(d=c.vp)||delete d.verifiableCredential),e.iss&&!e.holder&&(c.holder=e.iss,t&&delete c.iss),e.aud&&(c.verifier=[...i(e.verifier),...i(e.aud)].filter(a),c.verifier=[...new Set(c.verifier)],t&&delete c.aud),e.jti&&-1===Object.getOwnPropertyNames(e).indexOf("id")&&(c.id=e.id||e.jti,t&&delete c.jti);const f=[...i(e.type),...i(null==(n=e.vp)?void 0:n.type)].filter(a);var u;c.type=[...new Set(f)],t&&(null==(u=c.vp)||delete u.type);const p=[...i(e.context),...i(e["@context"]),...i(null==(l=e.vp)?void 0:l["@context"])].filter(a);var v;return c["@context"]=[...new Set(p)],t&&(delete c.context,null==(v=c.vp)||delete v["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(c.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete c.nbf:delete c.iat)),!e.expirationDate&&e.exp&&(c.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete c.exp),c.vp&&0===Object.keys(c.vp).length&&t&&delete c.vp,c}function u(t,r=!0){let n;try{n=e.decodeJWT(t)}catch(e){throw new TypeError("unknown presentation format")}return{...f(n.payload,r),proof:{type:"JwtProof2020",jwt:t}}}function p(e,r=!0){var n;if("string"==typeof e){if(t.test(e))return u(e,r);{let t;try{t=JSON.parse(e)}catch(e){throw new TypeError("unknown presentation format")}return p(t,r)}}return null!=(n=e.proof)&&n.jwt?{...u(e.proof.jwt,r),proof:e.proof}:{proof:{},...f(e,r)}}function v(e,t=!0){var r,n,l;const c=o({vp:{...e.vp},...e});c.vp=c.vp;const s=[...i(e.context),...i(e["@context"]),...i(null==(r=e.vp)?void 0:r["@context"])].filter(a);c.vp["@context"]=[...new Set(s)],t&&(delete c.context,delete c["@context"]);const d=[...i(e.type),...i(null==(n=e.vp)?void 0:n.type)].filter(a);if(c.vp.type=[...new Set(d)],t&&delete c.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(c.jti=e.id,t&&delete c.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const r=Date.parse(e.issuanceDate);isNaN(r)||(c.nbf=Math.floor(r/1e3),t&&delete c.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const r=Date.parse(e.expirationDate);isNaN(r)||(c.exp=Math.floor(r/1e3),t&&delete c.expirationDate)}var f;if((c.verifiableCredential||null!=(l=c.vp)&&l.verifiableCredential)&&(c.vp.verifiableCredential=[...i(c.verifiableCredential),...i(null==(f=c.vp)?void 0:f.verifiableCredential)].filter(a).map(e=>{var t;return"object"==typeof e&&null!=(t=e.proof)&&t.jwt?e.proof.jwt:e})),t&&delete c.verifiableCredential,e.holder&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&"string"==typeof e.holder&&(c.iss=e.holder,t&&delete c.holder),e.verifier){const r=[...i(e.verifier),...i(e.aud)].filter(a);c.aud=[...new Set(r)],t&&delete c.verifier}return c}function y(e){if("string"==typeof e&&!e.match(t))throw new TypeError(`"${e}" is not a valid JWT format`)}function b(e){if("number"==typeof e){if(!(Number.isInteger(e)&&e<1e11))throw new TypeError(`"${e}" is not a unix timestamp in seconds`)}else if("string"==typeof e)b(Math.floor(new Date(e).valueOf()/1e3));else if(!(t=e)||isNaN(t)||"[object Date]"!==Object.prototype.toString.call(t))throw new TypeError(`"${e}" is not a valid time`);var t}function x(e){const t=i(e);if(t.length<1||-1===t.indexOf(r))throw new TypeError(`@context is missing default context "${r}"`)}function w(e){const t=i(e);if(t.length<1||-1===t.indexOf("VerifiableCredential"))throw new TypeError('type is missing default "VerifiableCredential"')}function j(e){const t=i(e);if(t.length<1||-1===t.indexOf("VerifiablePresentation"))throw new TypeError('type is missing default "VerifiablePresentation"')}function g(e){if(0===Object.keys(e).length)throw new TypeError("credentialSubject must not be empty")}function h(e){x(e.vc["@context"]),w(e.vc.type),g(e.vc.credentialSubject),e.nbf&&b(e.nbf),e.exp&&b(e.exp)}function O(e){x(e["@context"]),w(e.type),g(e.credentialSubject),e.issuanceDate&&b(e.issuanceDate),e.expirationDate&&b(e.expirationDate)}function m(e){if(x(e.vp["@context"]),j(e.vp.type),e.vp.verifiableCredential&&e.vp.verifiableCredential.length>=1)for(const t of i(e.vp.verifiableCredential))"string"==typeof t?y(t):O(t);e.exp&&b(e.exp)}function S(e){if(x(e["@context"]),j(e.type),e.verifiableCredential&&e.verifiableCredential.length>=1)for(const t of e.verifiableCredential)"string"==typeof t?y(t):O(t);e.expirationDate&&b(e.expirationDate)}function P(e,t){if(t.challenge&&t.challenge!==e.nonce)throw new Error(`Presentation does not contain the mandatory challenge (JWT: nonce) for : ${t.challenge}`);if(t.domain){let r;if(e.aud&&(r=(Array.isArray(e.aud)?e.aud:[e.aud]).find(e=>t.domain===e)),void 0===r)throw new Error(`Presentation does not contain the mandatory domain (JWT: aud) for : ${t.domain}`)}}exports.createVerifiableCredentialJwt=function(t,r,n={}){try{var i;const o={iat:void 0,...d(t,n.removeOriginalFields)};return h(o),Promise.resolve(e.createJWT(o,{...n,issuer:r.did||o.iss||"",signer:r.signer},{...n.header,alg:r.alg||(null==(i=n.header)?void 0:i.alg)||"ES256K"}))}catch(e){return Promise.reject(e)}},exports.createVerifiablePresentationJwt=function(t,r,n={}){try{var o;const l={iat:void 0,...v(t,null==n?void 0:n.removeOriginalFields)};if(n.challenge&&-1===Object.getOwnPropertyNames(l).indexOf("nonce")&&(l.nonce=n.challenge),n.domain){const e=[...i(n.domain),...i(l.aud)].filter(a);l.aud=[...new Set(e)]}return m(l),Promise.resolve(e.createJWT(l,{...n,issuer:r.did||l.iss||"",signer:r.signer},{...n.header,alg:r.alg||(null==(o=n.header)?void 0:o.alg)||"ES256K"}))}catch(e){return Promise.reject(e)}},exports.normalizeCredential=s,exports.normalizePresentation=p,exports.transformCredentialInput=d,exports.transformPresentationInput=v,exports.validateCredentialPayload=O,exports.validateJwtCredentialPayload=h,exports.validateJwtPresentationPayload=m,exports.validatePresentationPayload=S,exports.verifyCredential=function(t,r,n={}){try{return Promise.resolve(e.verifyJWT(t,{resolver:r,...n})).then(function(e){return e.verifiableCredential=s(e.jwt,null==n?void 0:n.removeOriginalFields),O(e.verifiableCredential),e})}catch(e){return Promise.reject(e)}},exports.verifyPresentation=function(t,r,n={}){try{return Promise.resolve(e.verifyJWT(t,{resolver:r,...n})).then(function(e){return P(e.payload,n),e.verifiablePresentation=p(e.jwt,null==n?void 0:n.removeOriginalFields),S(e.verifiablePresentation),e})}catch(e){return Promise.reject(e)}},exports.verifyPresentationPayloadOptions=P;
//# sourceMappingURL=index.js.map
