import{decodeJWT as e,verifyJWT as t,createJWT as r}from"did-jwt";const n=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/,i="https://www.w3.org/2018/credentials/v1",o=["evidence","termsOfUse","refreshService","credentialSchema","credentialStatus"];function a(e){return Array.isArray(e)?e:[e]}function l(e){return Array.isArray(e)?e.map(e=>l(e)):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce((t,r)=>(Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r)),t[r]=l(e[r]),t),Object.create(Object.getPrototypeOf(e))):e}function c(e){return null!=e}function s(e,t=!0){var r,n,s,d;let f=l(e);var u,p,v;"object"==typeof(u=e)&&u.sub&&u.iss&&u.claim&&u.iat&&(f=function(e){const{iat:t,nbf:r,claim:n,vc:o,...a}=e,l={...a,nbf:r||t,vc:{"@context":[i],type:["VerifiableCredential"],credentialSubject:n}};return o&&(e.issVc=o),l}(e)),f.credentialSubject={...e.credentialSubject,...null==(r=e.vc)?void 0:r.credentialSubject},!e.sub||null!=(n=e.credentialSubject)&&n.id||!f.credentialSubject||(f.credentialSubject.id=e.sub,t&&delete f.sub),t&&(null==(p=f.vc)||delete p.credentialSubject),void 0!==e.issuer&&"object"!=typeof e.issuer||(f.issuer=function(e){if("object"!=typeof e)return e;const t={...e};return Object.keys(t).forEach(e=>void 0===t[e]&&delete t[e]),t}({id:e.iss,...e.issuer}),!t||null!=(v=e.issuer)&&v.id||delete f.iss),!e.id&&e.jti&&(f.id=f.id||f.jti,t&&delete f.jti);const b=[...a(f.type),...a(null==(s=f.vc)?void 0:s.type)].filter(c);var y;f.type=[...new Set(b)],t&&(null==(y=f.vc)||delete y.type);for(const r of o)e.vc&&e.vc[r]&&(f[r]||(f[r]=e.vc[r]),t&&delete f.vc[r]);const w=[...a(e.context),...a(e["@context"]),...a(null==(d=e.vc)?void 0:d["@context"])].filter(c);var x;return f["@context"]=[...new Set(w)],t&&(delete f.context,null==(x=f.vc)||delete x["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(f.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete f.nbf:delete f.iat)),!e.expirationDate&&e.exp&&(f.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete f.exp),t&&f.vc&&0===Object.keys(f.vc).length&&delete f.vc,f}function d(t,r=!0){let n;try{n=e(t)}catch(e){throw new TypeError("unknown credential format")}return{...s(n.payload,r),proof:{type:"JwtProof2020",jwt:t}}}function f(e,t=!0){var r;if("string"==typeof e){if(n.test(e))return d(e,t);{let r;try{r=JSON.parse(e)}catch(e){throw new TypeError("unknown credential format")}return f(r,t)}}return null!=(r=e.proof)&&r.jwt?l({...d(e.proof.jwt,t),proof:e.proof}):{proof:{},...s(e,t)}}function u(e,t=!0){var r,n,i;if(Array.isArray(e.credentialSubject))throw Error("credentialSubject of type array not supported");const s=l({vc:{...e.vc},...e});s.vc=s.vc;const d={...e.credentialSubject,...null==(r=e.vc)?void 0:r.credentialSubject};var f;e.sub||(s.sub=null==(f=e.credentialSubject)?void 0:f.id,t&&delete d.id);const u=[...a(e.context),...a(e["@context"]),...a(null==(n=e.vc)?void 0:n["@context"])].filter(c);s.vc["@context"]=[...new Set(u)],t&&(delete s.context,delete s["@context"]);const p=[...a(e.type),...a(null==(i=e.vc)?void 0:i.type)].filter(c);if(s.vc.type=[...new Set(p)],t&&delete s.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(s.jti=e.id,t&&delete s.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const r=Date.parse(e.issuanceDate);isNaN(r)||(s.nbf=Math.floor(r/1e3),t&&delete s.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const r=Date.parse(e.expirationDate);isNaN(r)||(s.exp=Math.floor(r/1e3),t&&delete s.expirationDate)}var v;e.issuer&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&("object"==typeof e.issuer?(s.iss=null==(v=e.issuer)?void 0:v.id,t&&(delete s.issuer.id,0===Object.keys(s.issuer).length&&delete s.issuer)):"string"==typeof e.issuer&&(s.iss=e.iss||""+e.issuer,t&&delete s.issuer)),s.vc.credentialSubject=d,t&&delete s.credentialSubject;for(const r of o)e[r]&&(s.vc[r]||(s.vc[r]=e[r]),t&&delete s[r]);return s}function p(e,t=!0){var r,n,i;const o=l(e);var s;o.verifiableCredential=[...a(e.verifiableCredential),...a(null==(r=e.vp)?void 0:r.verifiableCredential)].filter(c),o.verifiableCredential=o.verifiableCredential.map(e=>f(e,t)),t&&(null==(s=o.vp)||delete s.verifiableCredential),e.iss&&!e.holder&&(o.holder=e.iss,t&&delete o.iss),e.aud&&(o.verifier=[...a(e.verifier),...a(e.aud)].filter(c),o.verifier=[...new Set(o.verifier)],t&&delete o.aud),e.jti&&-1===Object.getOwnPropertyNames(e).indexOf("id")&&(o.id=e.id||e.jti,t&&delete o.jti);const d=[...a(e.type),...a(null==(n=e.vp)?void 0:n.type)].filter(c);var u;o.type=[...new Set(d)],t&&(null==(u=o.vp)||delete u.type);const p=[...a(e.context),...a(e["@context"]),...a(null==(i=e.vp)?void 0:i["@context"])].filter(c);var v;return o["@context"]=[...new Set(p)],t&&(delete o.context,null==(v=o.vp)||delete v["@context"]),e.issuanceDate||!e.iat&&!e.nbf||(o.issuanceDate=new Date(1e3*(e.nbf||e.iat)).toISOString(),t&&(e.nbf?delete o.nbf:delete o.iat)),!e.expirationDate&&e.exp&&(o.expirationDate=new Date(1e3*e.exp).toISOString(),t&&delete o.exp),o.vp&&0===Object.keys(o.vp).length&&t&&delete o.vp,o}function v(t,r=!0){let n;try{n=e(t)}catch(e){throw new TypeError("unknown presentation format")}return{...p(n.payload,r),proof:{type:"JwtProof2020",jwt:t}}}function b(e,t=!0){var r;if("string"==typeof e){if(n.test(e))return v(e,t);{let r;try{r=JSON.parse(e)}catch(e){throw new TypeError("unknown presentation format")}return b(r,t)}}return null!=(r=e.proof)&&r.jwt?{...v(e.proof.jwt,t),proof:e.proof}:{proof:{},...p(e,t)}}function y(e,t=!0){var r,n,i;const o=l({vp:{...e.vp},...e});o.vp=o.vp;const s=[...a(e.context),...a(e["@context"]),...a(null==(r=e.vp)?void 0:r["@context"])].filter(c);o.vp["@context"]=[...new Set(s)],t&&(delete o.context,delete o["@context"]);const d=[...a(e.type),...a(null==(n=e.vp)?void 0:n.type)].filter(c);if(o.vp.type=[...new Set(d)],t&&delete o.type,e.id&&-1===Object.getOwnPropertyNames(e).indexOf("jti")&&(o.jti=e.id,t&&delete o.id),e.issuanceDate&&-1===Object.getOwnPropertyNames(e).indexOf("nbf")){const r=Date.parse(e.issuanceDate);isNaN(r)||(o.nbf=Math.floor(r/1e3),t&&delete o.issuanceDate)}if(e.expirationDate&&-1===Object.getOwnPropertyNames(e).indexOf("exp")){const r=Date.parse(e.expirationDate);isNaN(r)||(o.exp=Math.floor(r/1e3),t&&delete o.expirationDate)}var f;if((o.verifiableCredential||null!=(i=o.vp)&&i.verifiableCredential)&&(o.vp.verifiableCredential=[...a(o.verifiableCredential),...a(null==(f=o.vp)?void 0:f.verifiableCredential)].filter(c).map(e=>{var t;return"object"==typeof e&&null!=(t=e.proof)&&t.jwt?e.proof.jwt:e})),t&&delete o.verifiableCredential,e.holder&&-1===Object.getOwnPropertyNames(e).indexOf("iss")&&"string"==typeof e.holder&&(o.iss=e.holder,t&&delete o.holder),e.verifier){const r=[...a(e.verifier),...a(e.aud)].filter(c);o.aud=[...new Set(r)],t&&delete o.verifier}return o}function w(e){if("string"==typeof e&&!e.match(n))throw new TypeError(`"${e}" is not a valid JWT format`)}function x(e){if("number"==typeof e){if(!(Number.isInteger(e)&&e<1e11))throw new TypeError(`"${e}" is not a unix timestamp in seconds`)}else if("string"==typeof e)x(Math.floor(new Date(e).valueOf()/1e3));else if(!(t=e)||isNaN(t)||"[object Date]"!==Object.prototype.toString.call(t))throw new TypeError(`"${e}" is not a valid time`);var t}function j(e){const t=a(e);if(t.length<1||-1===t.indexOf(i))throw new TypeError(`@context is missing default context "${i}"`)}function g(e){const t=a(e);if(t.length<1||-1===t.indexOf("VerifiableCredential"))throw new TypeError('type is missing default "VerifiableCredential"')}function h(e){const t=a(e);if(t.length<1||-1===t.indexOf("VerifiablePresentation"))throw new TypeError('type is missing default "VerifiablePresentation"')}function O(e){if(0===Object.keys(e).length)throw new TypeError("credentialSubject must not be empty")}const m=function(e,r,n={}){try{return Promise.resolve(t(e,{resolver:r,...n})).then(function(e){return A(e.payload,n),e.verifiablePresentation=b(e.jwt,null==n?void 0:n.removeOriginalFields),T(e.verifiablePresentation),e})}catch(e){return Promise.reject(e)}},S=function(e,r,n={}){try{return Promise.resolve(t(e,{resolver:r,...n})).then(function(e){return e.verifiableCredential=f(e.jwt,null==n?void 0:n.removeOriginalFields),C(e.verifiableCredential),e})}catch(e){return Promise.reject(e)}},D=function(e,t,n={}){try{var i;const o={iat:void 0,...y(e,null==n?void 0:n.removeOriginalFields)};if(n.challenge&&-1===Object.getOwnPropertyNames(o).indexOf("nonce")&&(o.nonce=n.challenge),n.domain){const e=[...a(n.domain),...a(o.aud)].filter(c);o.aud=[...new Set(e)]}return E(o),Promise.resolve(r(o,{...n,issuer:t.did||o.iss||"",signer:t.signer},{...n.header,alg:t.alg||(null==(i=n.header)?void 0:i.alg)||"ES256K"}))}catch(e){return Promise.reject(e)}},P=function(e,t,n={}){try{var i;const o={iat:void 0,...u(e,n.removeOriginalFields)};return N(o),Promise.resolve(r(o,{...n,issuer:t.did||o.iss||"",signer:t.signer},{...n.header,alg:t.alg||(null==(i=n.header)?void 0:i.alg)||"ES256K"}))}catch(e){return Promise.reject(e)}};function N(e){j(e.vc["@context"]),g(e.vc.type),O(e.vc.credentialSubject),e.nbf&&x(e.nbf),e.exp&&x(e.exp)}function C(e){j(e["@context"]),g(e.type),O(e.credentialSubject),e.issuanceDate&&x(e.issuanceDate),e.expirationDate&&x(e.expirationDate)}function E(e){if(j(e.vp["@context"]),h(e.vp.type),e.vp.verifiableCredential&&e.vp.verifiableCredential.length>=1)for(const t of a(e.vp.verifiableCredential))"string"==typeof t?w(t):C(t);e.exp&&x(e.exp)}function T(e){if(j(e["@context"]),h(e.type),e.verifiableCredential&&e.verifiableCredential.length>=1)for(const t of e.verifiableCredential)"string"==typeof t?w(t):C(t);e.expirationDate&&x(e.expirationDate)}function A(e,t){if(t.challenge&&t.challenge!==e.nonce)throw new Error(`Presentation does not contain the mandatory challenge (JWT: nonce) for : ${t.challenge}`);if(t.domain){let r;if(e.aud&&(r=(Array.isArray(e.aud)?e.aud:[e.aud]).find(e=>t.domain===e)),void 0===r)throw new Error(`Presentation does not contain the mandatory domain (JWT: aud) for : ${t.domain}`)}}export{P as createVerifiableCredentialJwt,D as createVerifiablePresentationJwt,f as normalizeCredential,b as normalizePresentation,u as transformCredentialInput,y as transformPresentationInput,C as validateCredentialPayload,N as validateJwtCredentialPayload,E as validateJwtPresentationPayload,T as validatePresentationPayload,S as verifyCredential,m as verifyPresentation,A as verifyPresentationPayloadOptions};
//# sourceMappingURL=index.module.js.map
